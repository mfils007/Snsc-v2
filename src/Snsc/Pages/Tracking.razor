@page "/tracking"
@using System.Net.Http.Json
@using SNSC.SHARED
@using static SNSC.SHARED.TrackingDtos
@using MudBlazor
@inject HttpClient Http

<MudPaper Class="pa-8" Elevation="4" Rounded="true"
          Style="max-width: 900px; margin: auto; background-color: white;">
    <MudText Typo="Typo.h4" Class="mb-2" Color="Color.Primary">
        Suivi de demande de passeport
    </MudText>

    <MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">
        Consultez l’état de votre demande en toute sécurité.
    </MudText>


    <MudGrid Spacing="2">
        <MudItem xs="12" sm="7">
            <MudTextField @bind-Value="numeroDossier"
                          Label="Numéro de dossier"
                          Variant="Variant.Outlined"
                          Placeholder="Ex: ABCD1234"
                          Immediate="true" />
        </MudItem>

        <MudItem xs="12" sm="5">
            <MudDatePicker Label="Date de naissance"
                           Variant="Variant.Outlined"
                           @bind-Date="dateNaissanceDateTime"
                           DateFormat="yyyy-MM-dd" />
        </MudItem>

        <MudItem xs="12">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@loading"
                       OnClick="Rechercher">
                @if (loading)
                {
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Search"
                               Disabled="@loading"
                               OnClick="Rechercher">
                        Rechercher
                    </MudButton>
                }
                else
                {
                    <span>Rechercher</span>
                }
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       Size="Size.Large"
                       Class="ml-3"
                       OnClick="Reset">
                Réinitialiser
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (error is not null)
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@error</MudAlert>
    }
</MudPaper>

@if (result is not null)
{
    <MudPaper Class="pa-6 mt-4" Elevation="2" Rounded="true">
        <MudText Typo="Typo.h6">Résultat</MudText>

        <MudGrid Spacing="2" Class="mt-2">
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.subtitle2">Numéro de dossier</MudText>
                <MudText Typo="Typo.body1">@result.NumeroDossier</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.subtitle2">Statut actuel</MudText>
                <MudChip T="string" Value="@result.StatutActuel" Color="Color.Success" Variant="Variant.Filled">
                    @result.StatutActuel
                </MudChip>

            </MudItem>
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2">Dernière mise à jour</MudText>
                <MudText Typo="Typo.body1">@result.DerniereMiseAJourUtc.ToLocalTime()</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.subtitle1" Class="mb-2">Historique</MudText>

        <MudTimeline>
            @foreach (var h in result.Historique.OrderByDescending(x => x.DateUtc))
            {
                <MudTimelineItem>
                    <MudText Typo="Typo.subtitle2">@h.Statut</MudText>
                    <MudText Typo="Typo.caption">@h.DateUtc.ToLocalTime()</MudText>
                    @if (!string.IsNullOrWhiteSpace(h.Commentaire))
                    {
                        <MudText Typo="Typo.body2">@h.Commentaire</MudText>
                    }
                </MudTimelineItem>
            }
        </MudTimeline>
    </MudPaper>
}

@code {
    private string numeroDossier = "";
    private DateOnly dateNaissance = new DateOnly(2000, 1, 1);

    // MudDatePicker utilise DateTime?
    private DateTime? dateNaissanceDateTime
    {
        get => new DateTime(dateNaissance.Year, dateNaissance.Month, dateNaissance.Day);
        set
        {
            if (value.HasValue)
                dateNaissance = DateOnly.FromDateTime(value.Value);
        }
    }

    private bool loading;
    private string? error;
    private TrackingResponse? result;

    private async Task Rechercher()
    {
        error = null;
        result = null;
        loading = true;

        try
        {
            if (string.IsNullOrWhiteSpace(numeroDossier))
            {
                error = "Veuillez entrer un numéro de dossier.";
                return;
            }

            var req = new TrackingRequest(numeroDossier.Trim(), dateNaissance);
            var resp = await Http.PostAsJsonAsync("api/tracking", req);

            if (resp.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                error = "Aucun dossier trouvé avec ces informations.";
                return;
            }

            resp.EnsureSuccessStatusCode();
            result = await resp.Content.ReadFromJsonAsync<TrackingResponse>();
        }
        catch
        {
            error = "Erreur technique. Veuillez réessayer.";
        }
        finally
        {
            loading = false;
        }
    }

    private void Reset()
    {
        numeroDossier = "";
        dateNaissance = new DateOnly(2000, 1, 1);
        error = null;
        result = null;
    }
}




